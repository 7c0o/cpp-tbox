#ifndef TBOX_NETWORK_BUFFERED_FD_H_20171030
#define TBOX_NETWORK_BUFFERED_FD_H_20171030

#include <functional>
#include <tbox/event/forward.h>
#include <tbox/base/defines.h>

#include "fd.h"
#include "buffer.h"

namespace tbox {
namespace network {

class BufferedFd {
  public:
    explicit BufferedFd(event::Loop *wp_loop);
    virtual ~BufferedFd();

    NONCOPYABLE(BufferedFd);

  public:
    using ReceiveCallback       = std::function<void(Buffer&)>;
    using WriteCompleteCallback = std::function<void()>;
    using ReadZeroCallback      = std::function<void()>;
    using ErrorCallback         = std::function<void(int)>;

    enum {
        kReadOnly  = 0x01,
        kWriteOnly = 0x02,
        kReadWrite = 0x03,
    };
    //! 初始化，并指定发送或是接收功能
    bool initialize(int fd, short events = kReadWrite);

    //! 设置接收到数据时的回调函数，threshold为数据阈值
    void setReceiveCallback(const ReceiveCallback &func, size_t threshold);
    //! 设置完成了当前数据发送时的回调函数
    void setSendCompleteCallback(const WriteCompleteCallback &func) { send_complete_cb_ = func; }
    //! 设置当读到0字节数据时回调函数
    void setReadZeroCallback(const ReadZeroCallback &func) { read_zero_cb_ = func; }
    //! 设置当遇到错误时的回调函数
    void setErrorCallback(const ErrorCallback &func) { error_cb_ = func; }

    //! 发送数据
    bool send(const void *data_ptr, size_t data_size);

    //! 启动与关闭内部事件驱动机制
    bool enable();
    bool disable();

  private:
    void onReadCallback(short);
    void onWriteCallback(short);

  private:
    event::Loop *wp_loop_ = nullptr;    //! 事件驱动

    enum class State {
        kEmpty,     //! 未初始化
        kInited,    //! 已初始化
        kRunning    //! 正在运行
    };
    State state_ = State::kEmpty;

    Fd fd_;

    event::FdItem *sp_read_event_  = nullptr;
    event::FdItem *sp_write_event_ = nullptr;

    Buffer send_buff_;
    Buffer recv_buff_;

    ReceiveCallback         receive_cb_;
    WriteCompleteCallback   send_complete_cb_;
    ReadZeroCallback        read_zero_cb_;
    ErrorCallback           error_cb_;

    size_t  receive_threshold_ = 0;
    int     cb_level_ = 0;
};

}
}

#endif //TBOX_NETWORK_BUFFERED_FD_H_20171030
